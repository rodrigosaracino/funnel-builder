<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Funnel Builder</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            overflow: hidden;
        }

        #root {
            width: 100vw;
            height: 100vh;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .dashboard {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .metric {
            text-align: center;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: bold;
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 16px;
        }

        .element-library {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .library-element {
            padding: 12px;
            border-radius: 8px;
            cursor: move;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .library-element:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .library-element:active {
            transform: scale(0.98);
        }

        .element-icon {
            font-size: 20px;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #f8fafc;
            background-image:
                linear-gradient(rgba(0, 0, 0, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 0, 0, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .canvas {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .funnel-element {
            position: absolute;
            width: 200px;
            padding: 15px;
            border-radius: 12px;
            cursor: move;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .funnel-element:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .funnel-element.selected {
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5);
        }

        .funnel-element.dragging {
            opacity: 0.7;
            cursor: grabbing;
        }

        .element-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            color: white;
        }

        .element-title {
            font-weight: 600;
            font-size: 14px;
            flex: 1;
        }

        .element-actions {
            display: flex;
            gap: 5px;
        }

        .element-btn {
            width: 24px;
            height: 24px;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .element-btn:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .element-metrics {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            padding: 8px;
            font-size: 11px;
            color: white;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .metric-row:last-child {
            margin-bottom: 0;
        }

        .connection-point {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid #4299e1;
            border-radius: 50%;
            cursor: crosshair;
            z-index: 10;
        }

        .connection-point.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-point.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-point:hover {
            background: #4299e1;
            transform: translateX(-50%) scale(1.3);
        }

        svg.connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }

        .connection-line {
            stroke: #4299e1;
            stroke-width: 3;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .properties-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }

        .properties-panel h3 {
            margin-bottom: 20px;
            color: #2d3748;
            font-size: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 600;
            color: #4a5568;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #4299e1;
        }

        .empty-state {
            color: #a0aec0;
            text-align: center;
            padding: 40px 20px;
            font-size: 14px;
        }

        .color-trafego { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .color-landing { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .color-email { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .color-video { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .color-webinar { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .color-checkout { background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); }
        .color-upsell { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2d3748; }
        .color-obrigado { background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2d3748; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const ELEMENT_TYPES = [
            { type: 'trafego', name: 'Tráfego', icon: '🎯', color: 'color-trafego' },
            { type: 'landing', name: 'Landing Page', icon: '📄', color: 'color-landing' },
            { type: 'email', name: 'Email', icon: '✉️', color: 'color-email' },
            { type: 'video', name: 'Vídeo', icon: '🎬', color: 'color-video' },
            { type: 'webinar', name: 'Webinar', icon: '🎥', color: 'color-webinar' },
            { type: 'checkout', name: 'Checkout', icon: '💳', color: 'color-checkout' },
            { type: 'upsell', name: 'Upsell', icon: '⬆️', color: 'color-upsell' },
            { type: 'obrigado', name: 'Obrigado', icon: '🎉', color: 'color-obrigado' }
        ];

        function FunnelBuilder() {
            const [elements, setElements] = useState([]);
            const [connections, setConnections] = useState([]);
            const [selectedElement, setSelectedElement] = useState(null);
            const [draggingElement, setDraggingElement] = useState(null);
            const [connectingFrom, setConnectingFrom] = useState(null);
            const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
            const canvasRef = useRef(null);

            const calculateMetrics = () => {
                const elementMap = {};
                elements.forEach(el => {
                    elementMap[el.id] = { ...el, children: [] };
                });

                connections.forEach(conn => {
                    if (elementMap[conn.from]) {
                        elementMap[conn.from].children.push(conn.to);
                    }
                });

                const calculateForElement = (id, parentMetrics = null) => {
                    const element = elementMap[id];
                    if (!element) return null;

                    let traffic = element.traffic || 0;
                    let conversion = element.conversion || 0;
                    let price = element.price || 0;
                    let cost = element.cost || 0;

                    if (parentMetrics) {
                        traffic = Math.round(parentMetrics.leads * (conversion / 100));
                    }

                    const leads = Math.round(traffic * (conversion / 100));
                    const revenue = leads * price;
                    const totalCost = traffic * cost;
                    const profit = revenue - totalCost;

                    element.calculatedMetrics = {
                        traffic,
                        leads,
                        revenue,
                        profit,
                        cost: totalCost
                    };

                    element.children.forEach(childId => {
                        calculateForElement(childId, element.calculatedMetrics);
                    });
                };

                elements.forEach(el => {
                    const hasParent = connections.some(conn => conn.to === el.id);
                    if (!hasParent) {
                        calculateForElement(el.id);
                    }
                });

                return elementMap;
            };

            const getDashboardMetrics = () => {
                const metricsMap = calculateMetrics();
                let totalRevenue = 0;
                let totalProfit = 0;
                let totalSales = 0;
                let totalCost = 0;

                Object.values(metricsMap).forEach(el => {
                    if (el.calculatedMetrics) {
                        totalRevenue += el.calculatedMetrics.revenue;
                        totalProfit += el.calculatedMetrics.profit;
                        totalSales += el.calculatedMetrics.leads;
                        totalCost += el.calculatedMetrics.cost;
                    }
                });

                const roi = totalCost > 0 ? ((totalProfit / totalCost) * 100) : 0;

                return {
                    revenue: totalRevenue,
                    profit: totalProfit,
                    roi: roi,
                    sales: totalSales
                };
            };

            const handleDragFromLibrary = (e, elementType) => {
                e.preventDefault();
                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left - 100;
                const y = e.clientY - rect.top - 50;

                const newElement = {
                    id: Date.now(),
                    type: elementType.type,
                    name: elementType.name,
                    icon: elementType.icon,
                    color: elementType.color,
                    x: Math.max(0, x),
                    y: Math.max(0, y),
                    traffic: 1000,
                    conversion: 10,
                    price: 100,
                    cost: 1
                };

                setElements([...elements, newElement]);
            };

            const handleElementMouseDown = (e, element) => {
                if (e.target.classList.contains('connection-point') ||
                    e.target.classList.contains('element-btn')) {
                    return;
                }

                e.stopPropagation();
                setSelectedElement(element.id);
                setDraggingElement(element.id);

                const rect = e.currentTarget.getBoundingClientRect();
                setDragOffset({
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                });
            };

            const handleMouseMove = (e) => {
                if (!draggingElement) return;

                const rect = canvasRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left - dragOffset.x;
                const y = e.clientY - rect.top - dragOffset.y;

                setElements(elements.map(el =>
                    el.id === draggingElement
                        ? { ...el, x: Math.max(0, x), y: Math.max(0, y) }
                        : el
                ));
            };

            const handleMouseUp = () => {
                setDraggingElement(null);
            };

            const handleConnectionStart = (e, elementId) => {
                e.stopPropagation();
                setConnectingFrom(elementId);
            };

            const handleConnectionEnd = (e, elementId) => {
                e.stopPropagation();
                if (connectingFrom && connectingFrom !== elementId) {
                    const connectionExists = connections.some(
                        conn => conn.from === connectingFrom && conn.to === elementId
                    );

                    if (!connectionExists) {
                        setConnections([...connections, { from: connectingFrom, to: elementId }]);
                    }
                }
                setConnectingFrom(null);
            };

            const handleDeleteElement = (e, elementId) => {
                e.stopPropagation();
                setElements(elements.filter(el => el.id !== elementId));
                setConnections(connections.filter(conn =>
                    conn.from !== elementId && conn.to !== elementId
                ));
                if (selectedElement === elementId) {
                    setSelectedElement(null);
                }
            };

            const updateElementProperty = (property, value) => {
                setElements(elements.map(el =>
                    el.id === selectedElement
                        ? { ...el, [property]: parseFloat(value) || 0 }
                        : el
                ));
            };

            const getConnectionPath = (fromId, toId) => {
                const fromEl = elements.find(el => el.id === fromId);
                const toEl = elements.find(el => el.id === toId);

                if (!fromEl || !toEl) return '';

                const fromX = fromEl.x + 100;
                const fromY = fromEl.y + 100;
                const toX = toEl.x + 100;
                const toY = toEl.y;

                const midY = (fromY + toY) / 2;

                return `M ${fromX} ${fromY} C ${fromX} ${midY}, ${toX} ${midY}, ${toX} ${toY}`;
            };

            const dashboardMetrics = getDashboardMetrics();
            const metricsMap = calculateMetrics();
            const selectedElementData = elements.find(el => el.id === selectedElement);

            return (
                <div className="app">
                    <div className="dashboard">
                        <div className="metric">
                            <div className="metric-label">Receita Total</div>
                            <div className="metric-value">
                                R$ {dashboardMetrics.revenue.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </div>
                        </div>
                        <div className="metric">
                            <div className="metric-label">Lucro Total</div>
                            <div className="metric-value">
                                R$ {dashboardMetrics.profit.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}
                            </div>
                        </div>
                        <div className="metric">
                            <div className="metric-label">ROI</div>
                            <div className="metric-value">
                                {dashboardMetrics.roi.toFixed(1)}%
                            </div>
                        </div>
                        <div className="metric">
                            <div className="metric-label">Total de Vendas</div>
                            <div className="metric-value">
                                {dashboardMetrics.sales.toLocaleString('pt-BR')}
                            </div>
                        </div>
                    </div>

                    <div className="main-content">
                        <div className="sidebar">
                            <h3>Elementos do Funil</h3>
                            <div className="element-library">
                                {ELEMENT_TYPES.map(type => (
                                    <div
                                        key={type.type}
                                        className={`library-element ${type.color}`}
                                        draggable
                                        onDragEnd={(e) => handleDragFromLibrary(e, type)}
                                    >
                                        <span className="element-icon">{type.icon}</span>
                                        <span>{type.name}</span>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div
                            className="canvas-container"
                            ref={canvasRef}
                            onMouseMove={handleMouseMove}
                            onMouseUp={handleMouseUp}
                            onClick={() => setSelectedElement(null)}
                        >
                            <svg className="connections">
                                <defs>
                                    <marker
                                        id="arrowhead"
                                        markerWidth="10"
                                        markerHeight="10"
                                        refX="9"
                                        refY="3"
                                        orient="auto"
                                    >
                                        <polygon points="0 0, 10 3, 0 6" fill="#4299e1" />
                                    </marker>
                                </defs>
                                {connections.map((conn, idx) => (
                                    <path
                                        key={idx}
                                        className="connection-line"
                                        d={getConnectionPath(conn.from, conn.to)}
                                    />
                                ))}
                            </svg>

                            <div className="canvas">
                                {elements.map(element => {
                                    const metrics = metricsMap[element.id]?.calculatedMetrics || {};
                                    return (
                                        <div
                                            key={element.id}
                                            className={`funnel-element ${element.color} ${
                                                selectedElement === element.id ? 'selected' : ''
                                            } ${draggingElement === element.id ? 'dragging' : ''}`}
                                            style={{
                                                left: element.x,
                                                top: element.y
                                            }}
                                            onMouseDown={(e) => handleElementMouseDown(e, element)}
                                        >
                                            <div
                                                className="connection-point top"
                                                onClick={(e) => handleConnectionEnd(e, element.id)}
                                            />

                                            <div className="element-header">
                                                <span className="element-icon">{element.icon}</span>
                                                <span className="element-title">{element.name}</span>
                                                <div className="element-actions">
                                                    <button
                                                        className="element-btn"
                                                        onClick={(e) => handleConnectionStart(e, element.id)}
                                                        title="Conectar"
                                                    >
                                                        🔗
                                                    </button>
                                                    <button
                                                        className="element-btn"
                                                        onClick={(e) => handleDeleteElement(e, element.id)}
                                                        title="Deletar"
                                                    >
                                                        🗑️
                                                    </button>
                                                </div>
                                            </div>

                                            <div className="element-metrics">
                                                <div className="metric-row">
                                                    <span>Tráfego:</span>
                                                    <strong>{metrics.traffic?.toLocaleString('pt-BR') || 0}</strong>
                                                </div>
                                                <div className="metric-row">
                                                    <span>Conversão:</span>
                                                    <strong>{element.conversion}%</strong>
                                                </div>
                                                <div className="metric-row">
                                                    <span>Leads:</span>
                                                    <strong>{metrics.leads?.toLocaleString('pt-BR') || 0}</strong>
                                                </div>
                                                <div className="metric-row">
                                                    <span>Receita:</span>
                                                    <strong>R$ {(metrics.revenue || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</strong>
                                                </div>
                                            </div>

                                            <div
                                                className="connection-point bottom"
                                                onClick={(e) => handleConnectionStart(e, element.id)}
                                            />
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="properties-panel">
                            <h3>Propriedades</h3>
                            {selectedElementData ? (
                                <div>
                                    <div className="form-group">
                                        <label className="form-label">Tráfego Inicial</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={selectedElementData.traffic}
                                            onChange={(e) => updateElementProperty('traffic', e.target.value)}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Taxa de Conversão (%)</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={selectedElementData.conversion}
                                            onChange={(e) => updateElementProperty('conversion', e.target.value)}
                                            step="0.1"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Preço (R$)</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={selectedElementData.price}
                                            onChange={(e) => updateElementProperty('price', e.target.value)}
                                            step="0.01"
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label className="form-label">Custo por Lead (R$)</label>
                                        <input
                                            type="number"
                                            className="form-input"
                                            value={selectedElementData.cost}
                                            onChange={(e) => updateElementProperty('cost', e.target.value)}
                                            step="0.01"
                                        />
                                    </div>
                                </div>
                            ) : (
                                <div className="empty-state">
                                    Selecione um elemento no canvas para editar suas propriedades
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<FunnelBuilder />, document.getElementById('root'));
    </script>
</body>
</html>